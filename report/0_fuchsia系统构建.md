## Fuchsia系统的编译构建  

> Fuchsia是Google开发的一个操作系统，采用Google开发的gn和ninja来编译整个系统。本篇文档记录了编译Fuchsia的过程、对于Fuchsia的构建系统的理解。

### GN与Ninja  

---

* 简单来说，GN与Ninja配合的来能够达到的效果与Makefile类似。其中GN能够用于解析\*.gn、\*.gni文件，GN对编译配置的有效性进行检查、将解析的结果整合到指定位置，生成的结果中包含\*.ninja文件。而Ninja的作用主要是在执行GN之后根据生成的各个.ninja文件及相关文件进行编译、构建。
* GN与Ninja支持多种语言混合编译，支持的语言包括c、cpp、rust。这是一个相关的[demo](https://github.com/PanQL/gn_example)，可以用于熟悉GN与Ninja的配合使用。Fuchsia的构建系统与该demo的架构有很相似的地方，后面将详细叙述。

### Fuchsia的构建  

----

* 源码获取  

  之所以将**获取源码**这一步骤单独说明，主要是由于人在国内的关系，踩了一些坑，特此记录。Google的Fuchsia官方源码在Google git上有一个镜像，但是同时，按照官方教程推荐的方式，获取源码需要使用到Google的jiri、cipd等工具。由于**某些不知名原因**，我在国庆假期前后都尝试了接近一周的时间，但是并没有能够成功拉取源码。主要遇到的问题包括:

  * cipd并需要的网络协议与Proxychains等命令行翻墙工具提供的并不兼容。所以自己搭建代理并没有成功。
  * 国内有重庆大学的可用镜像，但是由于时期特殊，只能下载到不完整的版本，下载之后由于某些隐藏文件夹丢失没有办法直接编译。

  最终通过解压Fuchsia虚拟机镜像的方法，得到了一份较为完整、可编译的Fuchsia代码，对应的官方代码是今年7月份的。现已放至[我的github仓库](https://github.com/PanQL/learningZircon)。

* 项目编译

  Google官方给出了一个fx脚本以及其调用的一系列子命令脚本，能够帮助编译、运行Fuchsia项目。该脚本在构建过程中依赖了.git目录下的一些文件，因而需要从远程的Google git仓库拉取更新，然后才能通过编译系统的检查。不过我发现直接将除了git相关的目录和文件之外的所有文件，移动到另一个空的git仓库中（我自己创建的），也可以编译&&运行。

  官方给出的编译指令格式如下:

  ```shell
  fx set bringup.x64 # 设置需要的产品等级和相应的硬件架构。实际是调用了gn
  fx build # 在上一步设置好的情况下、编译Fuchsia。实际是调用了ninja
  fx run # 在qemu中运行编译好的OS
  ```

  我在解决了更新问题之后，在qemu上得到的结果如下：

  